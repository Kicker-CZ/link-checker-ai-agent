name: Link Checker CI/CD

# –ö–æ–≥–¥–∞ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è workflow
on:
  # 1. –ó–∞–ø—É—Å–∫ –≤—Ä—É—á–Ω—É—é –∏–∑ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ GitHub
  workflow_dispatch:
    inputs:
      target_url:
        description: 'URL —Å—Ç—Ä–∞–Ω–∏—Ü—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏'
        required: true
        default: 'https://github.com'
      max_links:
        description: '–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ —á–∏—Å–ª–æ —Å—Å—ã–ª–æ–∫'
        required: false
        default: '100'

  # 2. –ü–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é (–∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 8 —É—Ç—Ä–∞ –ø–æ UTC)
  schedule:
    - cron: '0 8 * * *'

  # 3. –ü—Ä–∏ –∫–∞–∂–¥–æ–º push –∏–ª–∏ pull request –≤ main –≤–µ—Ç–∫—É
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

# –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–µ—Å–ª–∏ –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω—ã –≤—Ä—É—á–Ω—É—é)
env:
  DEFAULT_URL: "https:///www.google.com"
  DEFAULT_MAX_LINKS: 30

jobs:
  check-links:
    name: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Å—ã–ª–∫–∏ –Ω–∞ —Å–∞–π—Ç–µ
    runs-on: ubuntu-latest
    
    steps:
      # 1. –ü–æ–ª—É—á–∞–µ–º –∫–æ–¥ –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Python
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # 3. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # 4. –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—É—Å–∫–∞
      - name: Determine run parameters
        id: params
        run: |
          # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä—É—á–Ω–æ–π –≤–≤–æ–¥, –µ—Å–ª–∏ workflow –∑–∞–ø—É—â–µ–Ω –≤—Ä—É—á–Ω—É—é
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "TARGET_URL=${{ github.event.inputs.target_url }}" >> $GITHUB_OUTPUT
            echo "MAX_LINKS=${{ github.event.inputs.max_links }}" >> $GITHUB_OUTPUT
          else
            # –ò–Ω–∞—á–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            echo "TARGET_URL=$DEFAULT_URL" >> $GITHUB_OUTPUT
            echo "MAX_LINKS=$DEFAULT_MAX_LINKS" >> $GITHUB_OUTPUT
          fi
          
      # 5. –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É —Å—Å—ã–ª–æ–∫
      - name: Run link checker
        id: checker
        run: |
          echo "üîç –ù–∞—á–∏–Ω–∞—é –ø—Ä–æ–≤–µ—Ä–∫—É —Å—Å—ã–ª–æ–∫..."
          echo "URL: ${{ steps.params.outputs.TARGET_URL }}"
          echo "–ú–∞–∫—Å. —Å—Å—ã–ª–æ–∫: ${{ steps.params.outputs.MAX_LINKS }}"
          
          # –ó–∞–ø—É—Å–∫–∞–µ–º –∞–≥–µ–Ω—Ç–∞ –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤ JSON
          python main.py \
            "${{ steps.params.outputs.TARGET_URL }}" \
            --max-links "${{ steps.params.outputs.MAX_LINKS }}" \
            --output results.json \
            --verbose
          
          # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–ª—è summary
          TOTAL_LINKS=$(python -c "import json; data=json.load(open('results.json')); print(len(data))")
          WORKING_LINKS=$(python -c "import json; data=json.load(open('results.json')); print(sum(1 for r in data if r['ok']))")
          BROKEN_LINKS=$(python -c "import json; data=json.load(open('results.json')); print(sum(1 for r in data if not r['ok']))")
          
          echo "total_links=$TOTAL_LINKS" >> $GITHUB_OUTPUT
          echo "working_links=$WORKING_LINKS" >> $GITHUB_OUTPUT
          echo "broken_links=$BROKEN_LINKS" >> $GITHUB_OUTPUT

      # 6. –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∫–∞–∫ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç
      - name: Upload results as artifact
        uses: actions/upload-artifact@v4
        with:
          name: link-check-results
          path: |
            results.json
          retention-days: 7

           # 7. –°–æ–∑–¥–∞—ë–º —Å–≤–æ–¥–Ω—ã–π –æ—Ç—á—ë—Ç
      - name: Create summary report
        run: |
          echo "## üìä –û—Ç—á—ë—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Å—ã–ª–æ–∫" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**–ü—Ä–æ–≤–µ—Ä—è–µ–º—ã–π URL:** ${{ steps.params.outputs.TARGET_URL }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:**" >> $GITHUB_STEP_SUMMARY
          echo "- –í—Å–µ–≥–æ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ —Å—Å—ã–ª–æ–∫: ${{ steps.checker.outputs.total_links }}" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ –†–∞–±–æ—á–∏—Ö —Å—Å—ã–ª–æ–∫: ${{ steps.checker.outputs.working_links }}" >> $GITHUB_STEP_SUMMARY
          echo "- ‚ùå –ù–µ—Ä–∞–±–æ—á–∏—Ö —Å—Å—ã–ª–æ–∫: ${{ steps.checker.outputs.broken_links }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**–ü–æ–¥—Ä–æ–±–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã** —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ [–∞—Ä—Ç–µ—Ñ–∞–∫—Ç–µ link-check-results](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          
          # –ï—Å–ª–∏ –µ—Å—Ç—å –Ω–µ—Ä–∞–±–æ—á–∏–µ —Å—Å—ã–ª–∫–∏, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã–µ 5
          if [ "${{ steps.checker.outputs.broken_links }}" -gt 0 ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**–ü—Ä–∏–º–µ—Ä—ã –Ω–µ—Ä–∞–±–æ—á–∏—Ö —Å—Å—ã–ª–æ–∫:**" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            
            # –í–ê–ñ–ù–û: –í–æ—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –±–ª–æ–∫ Python –∫–æ–¥–∞
            python << 'EOF'
import json
with open('results.json') as f:
    data = json.load(f)
broken = [r for r in data if not r['ok']]
for i, r in enumerate(broken[:5]):
    print(f'{i+1}. {r["url"]}')
    print(f'   –°—Ç–∞—Ç—É—Å: {r["status"] or "N/A"}, –û—à–∏–±–∫–∞: {r["reason"]}')
EOF
            
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
          
      # 8. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
      - name: Send notification on failure
        if: failure()
        run: |
          echo "‚ùå Workflow –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π!"
          echo "–ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

      # 9. (–û–ü–¶–ò–û–ù–ê–õ–¨–ù–û) –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—ë–º issue –ø—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ –±–∏—Ç—ã—Ö —Å—Å—ã–ª–æ–∫
      - name: Create GitHub Issue if broken links found
        if: steps.checker.outputs.broken_links > 0 && github.event_name == 'schedule'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const results = JSON.parse(fs.readFileSync('results.json', 'utf8'));
            const brokenLinks = results.filter(r => !r.ok);
            
            // –§–æ—Ä–º–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ –±–∏—Ç—ã—Ö —Å—Å—ã–ª–æ–∫
            const brokenList = brokenLinks.slice(0, 20).map(link => 
              `- ${link.url} (${link.status || 'ERROR'}: ${link.reason})`
            ).join('\n');
            
            // –°–æ–∑–¥–∞—ë–º issue
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `üö® –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –±–∏—Ç—ã–µ —Å—Å—ã–ª–∫–∏ (${brokenLinks.length})`,
              body: `## –û—Ç—á—ë—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Å—ã–ª–æ–∫
              
**–ü—Ä–æ–≤–µ—Ä—è–µ–º—ã–π URL:** ${{ steps.params.outputs.TARGET_URL }}
**–í—Ä–µ–º—è –ø—Ä–æ–≤–µ—Ä–∫–∏:** ${new Date().toISOString()}

**–ù–∞–π–¥–µ–Ω–æ –±–∏—Ç—ã—Ö —Å—Å—ã–ª–æ–∫:** ${brokenLinks.length}

**–°–ø–∏—Å–æ–∫ –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö —Å—Å—ã–ª–æ–∫:**
${brokenList}

${brokenLinks.length > 20 ? `\n...–∏ –µ—â—ë ${brokenLinks.length - 20} —Å—Å—ã–ª–æ–∫` : ''}

**–ü–æ–ª–Ω—ã–π –æ—Ç—á—ë—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –≤ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞—Ö workflow.**
`
            });
