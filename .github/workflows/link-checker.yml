name: Link Checker CI/CD

on:
  workflow_dispatch:
    inputs:
      target_url:
        description: 'URL —Å—Ç—Ä–∞–Ω–∏—Ü—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏'
        required: true
        default: 'https://github.com'
      max_links:
        description: '–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ —á–∏—Å–ª–æ —Å—Å—ã–ª–æ–∫'
        required: false
        default: '100'
  schedule:
    - cron: '0 8 * * *'
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  DEFAULT_URL: "https://github.com"
  DEFAULT_MAX_LINKS: 50

jobs:
  check-links:
    name: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Å—ã–ª–∫–∏ –Ω–∞ —Å–∞–π—Ç–µ
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Determine run parameters
        id: params
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "TARGET_URL=${{ github.event.inputs.target_url }}" >> $GITHUB_OUTPUT
            echo "MAX_LINKS=${{ github.event.inputs.max_links }}" >> $GITHUB_OUTPUT
          else
            echo "TARGET_URL=$DEFAULT_URL" >> $GITHUB_OUTPUT
            echo "MAX_LINKS=$DEFAULT_MAX_LINKS" >> $GITHUB_OUTPUT
          fi
          
      - name: Run link checker
        id: checker
        run: |
          echo "üîç –ù–∞—á–∏–Ω–∞—é –ø—Ä–æ–≤–µ—Ä–∫—É —Å—Å—ã–ª–æ–∫..."
          echo "URL: ${{ steps.params.outputs.TARGET_URL }}"
          echo "–ú–∞–∫—Å. —Å—Å—ã–ª–æ–∫: ${{ steps.params.outputs.MAX_LINKS }}"
          
          python main.py \
            "${{ steps.params.outputs.TARGET_URL }}" \
            --max-links "${{ steps.params.outputs.MAX_LINKS }}" \
            --output results.json \
            --verbose
          
          TOTAL_LINKS=$(python -c "import json; data=json.load(open('results.json')); print(len(data))")
          WORKING_LINKS=$(python -c "import json; data=json.load(open('results.json')); print(sum(1 for r in data if r['ok']))")
          BROKEN_LINKS=$(python -c "import json; data=json.load(open('results.json')); print(sum(1 for r in data if not r['ok']))")
          
          echo "total_links=$TOTAL_LINKS" >> $GITHUB_OUTPUT
          echo "working_links=$WORKING_LINKS" >> $GITHUB_OUTPUT
          echo "broken_links=$BROKEN_LINKS" >> $GITHUB_OUTPUT

      - name: Upload results as artifact
        uses: actions/upload-artifact@v4
        with:
          name: link-check-results
          path: results.json
          retention-days: 7

      - name: Create summary report
        run: |
          echo "## üìä –û—Ç—á—ë—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Å—ã–ª–æ–∫" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**–ü—Ä–æ–≤–µ—Ä—è–µ–º—ã–π URL:** ${{ steps.params.outputs.TARGET_URL }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:**" >> $GITHUB_STEP_SUMMARY
          echo "- –í—Å–µ–≥–æ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ —Å—Å—ã–ª–æ–∫: ${{ steps.checker.outputs.total_links }}" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ –†–∞–±–æ—á–∏—Ö —Å—Å—ã–ª–æ–∫: ${{ steps.checker.outputs.working_links }}" >> $GITHUB_STEP_SUMMARY
          echo "- ‚ùå –ù–µ—Ä–∞–±–æ—á–∏—Ö —Å—Å—ã–ª–æ–∫: ${{ steps.checker.outputs.broken_links }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**–ü–æ–¥—Ä–æ–±–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã** —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ [–∞—Ä—Ç–µ—Ñ–∞–∫—Ç–µ link-check-results](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          
          # –ï—Å–ª–∏ –µ—Å—Ç—å –Ω–µ—Ä–∞–±–æ—á–∏–µ —Å—Å—ã–ª–∫–∏, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã–µ 5
          if [ "${{ steps.checker.outputs.broken_links }}" -gt 0 ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**–ü—Ä–∏–º–µ—Ä—ã –Ω–µ—Ä–∞–±–æ—á–∏—Ö —Å—Å—ã–ª–æ–∫:**" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            
            # –°–∞–º—ã–π –ø—Ä–æ—Å—Ç–æ–π –≤–∞—Ä–∏–∞–Ω—Ç - –æ–¥–Ω–∞ Python –∫–æ–º–∞–Ω–¥–∞
            python -c "
import json
with open('results.json') as f:
    data = json.load(f)
broken = [r for r in data if not r['ok']]
for i, r in enumerate(broken[:5]):
    print(f'{i+1}. {r[\"url\"]}')
    print(f'   –°—Ç–∞—Ç—É—Å: {r[\"status\"] or \"N/A\"}, –û—à–∏–±–∫–∞: {r[\"reason\"]}')
" >> $GITHUB_STEP_SUMMARY
            
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

      - name: Send notification on failure
        if: failure()
        run: |
          echo "‚ùå Workflow –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π!"
          echo "–ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

      - name: Create GitHub Issue if broken links found
        if: steps.checker.outputs.broken_links > 0 && github.event_name == 'schedule'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const results = JSON.parse(fs.readFileSync('results.json', 'utf8'));
            const brokenLinks = results.filter(r => !r.ok);
            
            const brokenList = brokenLinks.slice(0, 20).map(link => 
              `- ${link.url} (${link.status || 'ERROR'}: ${link.reason})`
            ).join('\n');
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `üö® –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –±–∏—Ç—ã–µ —Å—Å—ã–ª–∫–∏ (${brokenLinks.length})`,
              body: `## –û—Ç—á—ë—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Å—ã–ª–æ–∫
              
**–ü—Ä–æ–≤–µ—Ä—è–µ–º—ã–π URL:** ${{ steps.params.outputs.TARGET_URL }}
**–í—Ä–µ–º—è –ø—Ä–æ–≤–µ—Ä–∫–∏:** ${new Date().toISOString()}

**–ù–∞–π–¥–µ–Ω–æ –±–∏—Ç—ã—Ö —Å—Å—ã–ª–æ–∫:** ${brokenLinks.length}

**–°–ø–∏—Å–æ–∫ –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö —Å—Å—ã–ª–æ–∫:**
${brokenList}

${brokenLinks.length > 20 ? `\n...–∏ –µ—â—ë ${brokenLinks.length - 20} —Å—Å—ã–ª–æ–∫` : ''}

**–ü–æ–ª–Ω—ã–π –æ—Ç—á—ë—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –≤ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞—Ö workflow.**
`
            });
